var e,t,a,s,r=Object.defineProperty,l=(e,t,a)=>{if(!t.has(e))throw TypeError("Cannot "+a)},i=(e,t,a)=>(l(e,t,"read from private field"),a?a.call(e):t.get(e)),n=(e,t,a)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,a)},o=(e,t,a,s)=>(l(e,t,"write to private field"),s?s.call(e,a):t.set(e,a),a);import*as c from"https://cdn.skypack.dev/pin/@tensorflow/tfjs@v3.12.0-F9bp9qsyHrABR7f2JAQD/mode=imports,min/optimized/@tensorflow/tfjs.js";import{G as h,c as m,p as u,P as p,B as d}from"./util.dcef7bcf.js";import"./vendor.7bdb524c.js";import"https://cdn.skypack.dev/pin/react@v17.0.1-yH0aYV1FOvoIPeKBbHxg/mode=imports,min/optimized/react.js";const g=class{constructor(e,t=null){this.game=e,this.children={},this.U=0,this.N=0,this.V=0,this.P=null,this.nn_input=null,this.outcome=this.game.score,this.mother=t,this.outcome&&(this.V=this.outcome*this.game.player,this.U=this.V*(1/0))}static get n_states(){return[189]}static get n_actions(){return h.n_actions}createChild(e){let t=e.map(((e,t)=>e?t:null)).filter((e=>null!=e)),a=t.map((e=>this.game.clone()));t.forEach(((e,t)=>a[t].move(e))),this.children=Object.assign(...t.map(((e,t)=>({[e]:new g(a[t],this)}))))}explore(e){if(null!=this.outcome)throw"The game has ended with score: {this.outcome}";let t=this;for(;Object.keys(t.children).length&&null==t.outcome;){let e=t.children,a=Math.max(...Object.values(e).map((e=>e.U)));if(a==1/0){t.U=-1/0,t.V=-1;break}if(a==-1/0){t.U=1/0,t.V=1;break}let s=Object.entries(e).filter((([e,t])=>t.U==a)).map((([e,t])=>e));if(0==s.length)throw console.log(`current max_U = ${a}`),"No action to explore";let r=s[Math.floor(Math.random()*s.length)];t=e[r]}if(0==Object.keys(t.children).length&&null==t.outcome){t.nn_input={state:[].concat(t.game.board.flat().flat().flat().map((e=>1==e?1:0)),t.game.board.flat().flat().flat().map((e=>-1==e?1:0)),t.game.acquired.flat().map((e=>1==e?1:0)),t.game.acquired.flat().map((e=>-1==e?1:0)),[...Array(3).keys()].map((e=>t.game.available.slice(27*e,27*e+27))).map((e=>[...Array(3).keys()].map((t=>e.slice(9*t,9*t+9))).map((e=>e.some((e=>e))?1:0)))).flat()),availability:t.game.available.map((e=>e?1:0))};let[a,s]=e.predict([c.tensor(t.nn_input.state,g.n_states,"float32").expandDims(),c.tensor(t.nn_input.availability,[g.n_actions],"float32").expandDims()]);t.P=a.squeeze().arraySync(),t.V=s.squeeze().arraySync(),t.createChild(t.game.available)}for(t.N+=1;t.mother;){let e=t.mother;e.N+=1,e.V+=(-e.V-t.V)/e.N;let a=e.P;for(let[t,s]of Object.entries(e.children))s.U!=1/0&&s.U!=-1/0&&(s.U=s.V+g.C*a[t]*Math.sqrt(e.N)/(1+s.N));t=t.mother}}next(e=1){if(null!=this.outcome)throw`The Game has ended with score ${this.outcome}`;if(0==Object.keys(this.children).length)throw"No children found and game has not ended";let t,a=this.children;if(Math.max(...Object.values(a).map((e=>e.U)))==1/0)t=[...Array(g.n_actions).keys()].map((e=>e in a&&a[e].U==1/0?1:0));else{let s=Math.max(...Object.values(a).map((e=>e.N)))+1;t=[...Array(g.n_actions).keys()].map((t=>t in a?(a[t].N/s)**(1/e):0))}let s=t.reduce(((e,t)=>e+t),0);if(s>0)t=t.map((e=>e/s));else{let e=Object.keys(a).length;t=[...Array(g.n_actions).keys()].map((t=>t in a?1/e:0))}let r=[].concat(...t.map(((e,t)=>Array(Math.ceil(100*e)).fill(t)))),l=r[Math.floor(Math.random()*r.length)];return[a[l],{nn_input:this.nn_input,true_prob:t}]}detachMother(){delete this.mother,this.mother=null}};let y=g;var f;((e,t,a)=>{t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a})(y,"symbol"!=typeof(f="C")?f+"":f,1);class b extends c.layers.Layer{constructor(t){super(t),n(this,e,void 0),this.name=t.name,o(this,e,t.targetShape)}computeOutputShape(t){return[t[0],i(this,e)]}call(t){return c.tidy((()=>{let[a,s]=t[0].split([i(this,e),-1],1),r=s.mul(a.exp());return r.div(r.sum(1).reshape([-1,1]))}))}getConfig(){const t=super.getConfig();return Object.assign(t,{targetShape:i(this,e)}),t}static get className(){return"ActionProbabilityLayer"}}e=new WeakMap,c.serialization.registerClass(b);t=new WeakMap,a=new WeakMap,s=new WeakMap;const v=new class{constructor(e,r,l=.01,h=1e-4){n(this,t,void 0),n(this,a,void 0),n(this,s,void 0),o(this,a,l),o(this,s,h);let m=c.input({shape:e,dtype:"float32",name:"State"}),u=c.input({shape:[r],dtype:"float32",name:"AvailableActions"}),p=c.layers.dense({units:1024,activation:"relu",kernelRegularizer:c.regularizers.l2({l2:i(this,s)})}).apply(m);p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p),p=this.resnet_block(p);let d=c.layers.dense({units:512,activation:"relu",kernelRegularizer:c.regularizers.l2({l2:i(this,s)})}).apply(p),g=c.layers.dense({units:r,kernelRegularizer:c.regularizers.l2({l2:i(this,s)})}).apply(d),y=new b({name:"ActionProbabilities",targetShape:r}).apply(c.layers.concatenate().apply([g,u])),f=c.layers.dense({units:512,activation:"relu",kernelRegularizer:c.regularizers.l2({l2:i(this,s)})}).apply(p),v=c.layers.dense({units:1,activation:"tanh",name:"Value",kernelRegularizer:c.regularizers.l2({l2:i(this,s)})}).apply(f);o(this,t,c.model({inputs:[m,u],outputs:[y,v]})),this.compile()}resnet_block(e){let t=e;return e=c.layers.dense({units:1024,activation:"relu",kernelRegularizer:c.regularizers.l2({l2:i(this,s)})}).apply(e),e=c.layers.dense({units:1024,kernelRegularizer:c.regularizers.l2({l2:i(this,s)})}).apply(e),e=c.layers.add().apply([e,t]),e=c.layers.reLU().apply(e)}compile(){i(this,t).compile({optimizer:c.train.rmsprop(i(this,a)),loss:{ActionProbabilities:(e,t)=>{let a=e.add(Number.EPSILON).log().mul(e);return t.add(Number.EPSILON).log().mul(e).sub(a).sum(1).neg().sum()},Value:(e,t)=>t.squaredDifference(e).sum()},metrics:{Value:"mse"}})}set model(e){o(this,t,e)}summary(){i(this,t).summary()}predict(e){return i(this,t).predict(e)}evaluate(e,a){return i(this,t).evaluate(e,a)}async fit(e,a,s){return await i(this,t).fit(e,a,s)}getWeights(){return i(this,t).getWeights()}async save(e){await i(this,t).save(e)}load(e){this.model=e,this.compile()}}(y.n_states,y.n_actions);function k(e){let t=e.map(((e,t)=>e.map(((e,a)=>0==e?[t,a]:null)))).flat().filter((e=>e));return t[Math.floor(Math.random()*t.length)]}function _(e,t=!1){let a=(new Date).getTime();if(t){let t=.1,s=200,r=new y(new h(e));for(let e of[...Array(s).keys()])r.explore(v);let[l,i]=r.next(t),n=(new Date).getTime()-a;return n>=e.turn_delay?postMessage({move:l.game.action}):setTimeout((()=>postMessage({move:l.game.action})),e.turn_delay-n)}let s,{board:r,acquired:l}=e;if(null==e.last_move){let[e,t]=k(l),[a,i]=k(r[e][t]);s={R:e,C:t,r:a,c:i}}else{let{r:t,c:a}=e.last_move;if(0==l[t][a]){let[e,l]=k(r[t][a]);s={R:t,C:a,r:e,c:l}}else{let[e,t]=k(l),[a,i]=k(r[e][t]);s={R:e,C:t,r:a,c:i}}}let i=(new Date).getTime()-a;return i>=e.turn_delay?postMessage({move:s}):setTimeout((()=>postMessage({move:s})),e.turn_delay-i)}fetch("/check-saved-model").then(m).then(u).then((async({found:e})=>{e&&(v.load(await c.loadLayersModel(`${p}://${d}/model/model.json`,{onProgress:e=>postMessage({percentage:e})})),self.onmessage=({data:{context:e}})=>_(e,!0),v.summary()),postMessage({percentage:"done"})})).catch((e=>console.error(e))),onmessage=({data:{context:e}})=>_(e);
